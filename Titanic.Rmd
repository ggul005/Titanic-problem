---
title: "Machine Learning from Disaster: Titanic"
author: "Oleksandr Fialko"
date: "`r Sys.Date()`"
output: rmarkdown::html_notebook
---

This is my short summary of my investigation of the Titanic data set.
It consists of three parts:

- Data loading and preprocessing 
- Feature engineering
- Machine learning with Decision Tree

### 1 Manipulating Data
First, lets load data
```{r include=FALSE}
library(dplyr)
```


```{r}
train <- read.csv("files/train.csv", header = TRUE,stringsAsFactors = FALSE)
test <- read.csv("files/test.csv", header = TRUE,stringsAsFactors = FALSE)
```

We combine the two data sets, `train` and `test`, into one data set `data_full`.
`dplyr` library provides handy command `bind_rows`:  

```{r}
data_full <- bind_rows(train,test)

```

Let's check our data

```{r}
str(data_full)

```

`survived` and `pclass` features have 2 and 3 distinct values respectively. They better be converted into factors

```{r}
data_full$Survived <- as.factor(data_full$Survived)
data_full$Pclass <- as.factor(data_full$Pclass)
```

`pclass` is an important feature. Rich passengers traveled in higher `pclass` survived as higher rate as can be seen from the following plot
```{r include=FALSE}
library(ggplot2)
library(plotly)
```
```{r}
p<-ggplot(data_full[1:891,], aes(x = Pclass, fill = Survived)) +
  geom_bar(stat = 'count',position='dodge') +
  xlab("Pclass") +
  ylab("Count") +
  labs(fill = "Survived")+theme_light()
ggplotly(p)
```

### 2 Feature engineering

One powerful desired feature is `title`. It can be extracted from existing feature `name`. Each name in the full data set has a title in it. For example, the first passenger `Owen Haris` was titled as 'Mr.':
```{r include=FALSE}
library(stringi)
```

```{r}
data_full$Name[1]
```

So, let's extract titles from `name` using regular expressions:
```{r}
data_full$Title <- gsub('(.*, )|(\\..*)','',data_full$Name)
table(data_full$Sex,data_full$Title)
```

Too many titles. Let's group them
```{r}
data_full[data_full$Title %in% c("Dona", "the Countess"),'Title'] <- "Lady"
data_full[data_full$Title %in% c("Ms", "Mlle"),'Title'] <- "Miss"
data_full[data_full$Title == "Mme",'title'] <- "Mrs"
data_full[data_full$Title %in% c("Jonkheer", "Don"),'Title'] <- "Sir"
data_full[data_full$Title %in% c("Col", "Capt", "Major"),'Title'] <- "Officer"

data_full[data_full$Title == "Lady",'Title'] <- "Mrs"
data_full[data_full$Title %in% c("Rev", "Sir", "Officer"),'Title'] <- "Mr"
```

The title `Dr` is a bit tricky. There is one female with this title. Let's fix this:

```{r}
table(data_full$Sex,data_full$Title)
data_full[data_full$Sex=='female' & data_full$Title=='Dr','title']<-'Mrs'
data_full[data_full$Title=='Dr','Title'] <- 'Mr'
table(data_full$Sex,data_full$Title)
data_full$Title <- as.factor(data_full$Title)
```

```{r warning=FALSE}
p<-ggplot(data_full[1:891,], aes(x = Title, fill = Survived)) +
  geom_bar(stat='count') + facet_grid(.~Pclass)+
  xlab("Title") +
  ylab("Count") +
  labs(fill = "Survived")+theme_light()
ggplotly(p)
```

```{r}
mosaicplot(table(data_full$Title,data_full$Survived),main='title by survival')
```

```{r}
mosaicplot(table(data_full$Pclass,data_full$Survived),main='pclass by survival')
```

Main conclusions so far:

- people with the title 'Mr' had high probability to perish.
- people from the 3d class had high probability to perish.

One more feature which appeared to be useful is `family size`. It can be extracted by adding `sibsp` + `parch` + 1. We further bin the family size into 3 categories:

```{r}
data_full$familysize <- data_full$SibSp + data_full$Parch + 1

data_full$fsize[data_full$familysize==1] <- 'single'
data_full$fsize[data_full$familysize <= 4 & data_full$familysize > 1] <- 'small'
data_full$fsize[data_full$familysize >= 5] <- 'large'
data_full$fsize <- as.factor(data_full$fsize)
mosaicplot(table(data_full$fsize,data_full$Survived),main='famility size by survival')
```

There is a survival penalty for traveling with a large family.

### 3 Decision Tree

Random Forests are more powerful than single trees,
but single trees have the advantage of being easier to understand.

```{r include=F}
library(caret)
library(rpart)
library(rpart.plot)
```
```{r}
X <- data_full[1:891,c('Pclass','fsize','Title')]
y <- as.factor(data_full[1:891,'Survived'])

folds <- createMultiFolds(y, k = 3, times = 10)
ctrl  <- trainControl(method = "repeatedcv", number = 3, repeats = 10,
                       index = folds)

rpart.cv <- train(x = X, y = y, method = "rpart", tuneLength = 10, 
                    trControl = ctrl)


prp(rpart.cv$finalModel,type = 0, extra = 1, under = TRUE) # display the results 
```